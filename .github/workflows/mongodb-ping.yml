name: MongoDB Ping

# Run every 4 days at midnight UTC to keep the database connection alive
on:
  schedule:
    - cron: '0 0 */4 * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  ping-mongodb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install MongoDB driver
      run: npm install mongodb
      
    - name: Ping MongoDB
      run: |
        cat << 'EOF' > ping-mongodb.js
        const { MongoClient } = require('mongodb');
        
        async function pingMongoDB() {
          let client;
          
          try {
            console.log('ðŸ”Œ Connecting to MongoDB...');
            
            // Use GitHub secret for MongoDB URI, fallback to env var for local testing
            const mongoUri = process.env.MONGODB_URI || process.env.MONGO_URI;
            const databaseName = process.env.MONGO_DATABASE || 'url_shortener';
            
            if (!mongoUri) {
              throw new Error('MongoDB URI not found. Please set MONGODB_URI secret in GitHub.');
            }
            
            console.log('ðŸ”§ MongoDB URI found, connecting with TLS...');
            console.log('ðŸ“¦ Target database:', databaseName);
            
            // Configure MongoDB client with simplified options for GitHub Actions
            const clientOptions = {
              connectTimeoutMS: 30000,            // 30 seconds connection timeout
              serverSelectionTimeoutMS: 30000,    // 30 seconds server selection timeout
              socketTimeoutMS: 30000,             // 30 seconds socket timeout
              maxPoolSize: 10,                    // Limit connection pool
              retryWrites: true                   // Enable retryable writes
            };
            
            client = new MongoClient(mongoUri, clientOptions);
            await client.connect();
            
            console.log('âœ… Connected to MongoDB successfully');
            
            // Get database instance
            const db = client.db(databaseName);
            
            // Run ping command - this is a no-op that tests server responsiveness
            console.log('ðŸ“ Sending ping command...');
            const result = await db.command({ ping: 1 });
            
            if (result.ok === 1) {
              console.log('âœ… MongoDB ping successful!');
              console.log('ðŸ“Š Response:', JSON.stringify(result, null, 2));
              
              // Also get server status for additional health info
              console.log('ðŸ“¡ Fetching server status...');
              const serverStatus = await db.command({ 
                serverStatus: 1,
                connections: 1,
                network: 1,
                version: 1
              });
              
              console.log('ï¿½ï¸  MongoDB version:', serverStatus.version || 'N/A');
              console.log('ï¿½ðŸ”— Current connections:', serverStatus.connections?.current || 'N/A');
              console.log('ï¿½ Available connections:', serverStatus.connections?.available || 'N/A');
              console.log('ï¿½ðŸ“¡ Network bytes in:', serverStatus.network?.bytesIn || 'N/A');
              console.log('ðŸ“¡ Network bytes out:', serverStatus.network?.bytesOut || 'N/A');
              
              // Test database operations
              console.log('ðŸ§ª Testing database access...');
              const collections = await db.listCollections().toArray();
              console.log('ðŸ“š Collections found:', collections.length);
              
              if (collections.length > 0) {
                console.log('ðŸ“‹ Collection names:', collections.map(c => c.name).join(', '));
              }
              
            } else {
              throw new Error('MongoDB ping returned non-OK status');
            }
            
          } catch (error) {
            console.error('âŒ MongoDB ping failed:', error.message);
            
            if (error.code) {
              console.error('ðŸ”§ Error code:', error.code);
            }
            
            if (error.cause) {
              console.error('ðŸ” Root cause:', error.cause.message);
            }
            
            process.exit(1);
            
          } finally {
            if (client) {
              try {
                await client.close();
                console.log('ðŸ”Œ MongoDB connection closed');
              } catch (closeError) {
                console.error('âš ï¸  Error closing connection:', closeError.message);
              }
            }
          }
        }
        
        // Run the ping function
        pingMongoDB().then(() => {
          console.log('ðŸŽ‰ MongoDB ping workflow completed successfully');
        }).catch((error) => {
          console.error('ðŸ’¥ Workflow failed:', error.message);
          process.exit(1);
        });
        EOF
        
        node ping-mongodb.js
      env:
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        MONGO_DATABASE: ${{ secrets.MONGO_DATABASE || 'url_shortener' }}
        NODE_OPTIONS: '--use-openssl-ca'
        
    - name: Cleanup
      if: always()
      run: rm -f ping-mongodb.js
