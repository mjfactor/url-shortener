name: MongoDB Ping Keep-Alive

# Run every 4 days at midnight UTC
on:
  schedule:
    - cron: '0 0 */4 * *'  # Every 4 days at 00:00 UTC
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  ping-mongodb:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install MongoDB driver
        run: npm install mongodb

      - name: Ping MongoDB
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DATABASE: ${{ secrets.MONGO_DATABASE }}
        run: |
          node -e "
          const { MongoClient } = require('mongodb');
          
          async function pingMongoDB() {
            const uri = process.env.MONGO_URI;
            const database = process.env.MONGO_DATABASE || 'url_shortener';
            
            if (!uri) {
              console.error('‚ùå MONGO_URI secret not configured');
              process.exit(1);
            }
            
            // MongoDB Atlas specific options for GitHub Actions
            const options = {
              tls: true,
              tlsAllowInvalidCertificates: true,
              tlsAllowInvalidHostnames: true,
              serverSelectionTimeoutMS: 10000,
              connectTimeoutMS: 10000,
              socketTimeoutMS: 10000,
            };
            
            const client = new MongoClient(uri, options);
            
            try {
              console.log('üîå Connecting to MongoDB Atlas...');
              await client.connect();
              
              console.log('üì° Pinging MongoDB...');
              const db = client.db(database);
              const result = await db.admin().ping();
              
              console.log('‚úÖ MongoDB ping successful!');
              console.log('üìä Ping result:', result);
              
              // Optional: Get some basic stats (with error handling)
              try {
                const stats = await db.stats();
                console.log('üìà Database stats:');
                console.log('  - Collections:', stats.collections || 0);
                console.log('  - Data size:', Math.round((stats.dataSize || 0) / 1024), 'KB');
              } catch (statsError) {
                console.log('‚ÑπÔ∏è  Database stats not available:', statsError.message);
              }
              
            } catch (error) {
              console.error('‚ùå MongoDB ping failed:', error.message);
              console.error('üîç Error details:', {
                name: error.name,
                code: error.code,
                codeName: error.codeName
              });
              process.exit(1);
            } finally {
              try {
                await client.close();
                console.log('üîö Connection closed');
              } catch (closeError) {
                console.log('‚ö†Ô∏è  Error closing connection:', closeError.message);
              }
            }
          }
          
          pingMongoDB();
          "

      - name: Log completion
        if: success()
        run: |
          echo "‚úÖ MongoDB ping completed successfully at $(date)"
          echo "üïí Next ping scheduled in 4 days"

      - name: Log failure
        if: failure()
        run: |
          echo "‚ùå MongoDB ping failed at $(date)"
          echo "üîç Check the logs above for error details"
